<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ERKANBABAPÄ°ROSEX</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #0f0f0f; color: #fff; }
        .header { background: #212121; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { color: #f00; font-weight: bold; font-size: 20px; }
        .add-btn { background: #f00; color: #fff; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; }
        .container { padding: 12px; }
        .video-card { background: #1f1f1f; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; }
        video, iframe { width: 100%; height: 100%; }
        .info { padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 16px; font-weight: 500; }
        .meta { font-size: 12px; color: #aaa; }
        .delete-btn { background: #333; color: #ff4444; border: none; padding: 8px 12px; border-radius: 8px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #212121; padding: 20px; border-radius: 15px; width: 100%; max-width: 400px; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; }
        .save-btn { width: 100%; padding: 15px; background: #f00; color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ðŸ“º erkansexhub</div>
        <button class="add-btn" onclick="toggleModal(true)">+ Video Ekle</button>
    </div>

    <div class="container" id="videoGrid"></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 style="margin-bottom:10px">Yeni Video</h3>
            <input type="text" id="vTitle" placeholder="BaÅŸlÄ±k">
            <input type="url" id="vUrl" placeholder="YouTube URL (Ä°steÄŸe baÄŸlÄ±)">
            <p style="text-align:center; color:#666; font-size:12px; margin: 5px 0;">veya dosya yÃ¼kleyin:</p>
            <input type="file" id="vFile" accept="video/*">
            <button class="save-btn" id="saveBtn" onclick="handleSave()">KAYDET</button>
            <button onclick="toggleModal(false)" style="width:100%; background:none; border:none; color:#888; margin-top:15px; font-size: 14px;">VazgeÃ§</button>
        </div>
    </div>

    <script>
        let db;
        let activeBlobUrls = []; // Bellek sÄ±zÄ±ntÄ±sÄ±nÄ± Ã¶nlemek iÃ§in

        // IndexedDB BaÅŸlat
        const request = indexedDB.open("VideoHubDB", 1);
        request.onupgradeneeded = (e) => e.target.result.createObjectStore("videos", { keyPath: "id" });
        request.onsuccess = (e) => { db = e.target.result; displayVideos(); };

        function clearBlobUrls() {
            activeBlobUrls.forEach(url => URL.revokeObjectURL(url));
            activeBlobUrls = [];
        }

        async function displayVideos() {
            clearBlobUrls();
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = "";
            
            const tx = db.transaction("videos", "readonly");
            const store = tx.objectStore("videos");
            const items = await new Promise(res => store.getAll().onsuccess = (e) => res(e.target.result));

            items.sort((a,b) => b.id - a.id).forEach(item => {
                const card = document.createElement('div');
                card.className = 'video-card';
                
                let mediaHtml = '';
                if(item.type === 'url') {
                    const ytId = item.url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/);
                    mediaHtml = ytId ? `<iframe src="https://www.youtube.com/embed/${ytId[1]}" frameborder="0" allowfullscreen></iframe>` 
                                     : `<video src="${item.url}" controls playsinline></video>`;
                } else {
                    // BASE64 verisinden gerÃ§ek Blob oluÅŸturup URL atÄ±yoruz
                    const blob = base64ToBlob(item.data);
                    const bUrl = URL.createObjectURL(blob);
                    activeBlobUrls.push(bUrl);
                    mediaHtml = `<video src="${bUrl}" controls playsinline preload="metadata" poster=""></video>`;
                }

                card.innerHTML = `
                    <div class="video-wrapper">${mediaHtml}</div>
                    <div class="info">
                        <div>
                            <div class="title">${item.title}</div>
                            <div class="meta">${item.date}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteVideo(${item.id})">Sil</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function handleSave() {
            const title = document.getElementById('vTitle').value;
            const url = document.getElementById('vUrl').value;
            const file = document.getElementById('vFile').files[0];
            const btn = document.getElementById('saveBtn');

            if(!title) return alert("BaÅŸlÄ±k gerekli!");
            btn.disabled = true;
            btn.innerText = "YÃ¼kleniyor...";

            let newItem = { id: Date.now(), title, date: new Date().toLocaleDateString('tr-TR') };

            if(file) {
                if(file.size > 100 * 1024 * 1024) { btn.disabled = false; btn.innerText = "KAYDET"; return alert("100MB sÄ±nÄ±rÄ±!"); }
                const base64 = await new Promise(res => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.readAsDataURL(file);
                });
                newItem.type = 'file';
                newItem.data = base64;
            } else if(url) {
                newItem.type = 'url';
                newItem.url = url;
            } else {
                btn.disabled = false; btn.innerText = "KAYDET";
                return alert("Dosya seÃ§in veya link girin!");
            }

            const tx = db.transaction("videos", "readwrite");
            tx.objectStore("videos").add(newItem);
            tx.oncomplete = () => {
                toggleModal(false);
                displayVideos();
                btn.disabled = false;
                btn.innerText = "KAYDET";
            };
        }

        function base64ToBlob(base64) {
            const [header, data] = base64.split(';base64,');
            const type = header.split(':')[1];
            const binary = atob(data);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
            return new Blob([array], { type });
        }

        function deleteVideo(id) {
            if(!confirm("Bu videoyu silmek istiyor musunuz?")) return;
            const tx = db.transaction("videos", "readwrite");
            tx.objectStore("videos").delete(id);
            tx.oncomplete = () => displayVideos();
        }

        function toggleModal(show) {
            document.getElementById('modal').classList.toggle('active', show);
            if(!show) { 
                document.getElementById('vTitle').value = ""; 
                document.getElementById('vUrl').value = "";
                document.getElementById('vFile').value = "";
            }
        }
    </script>
</body>
</html>
